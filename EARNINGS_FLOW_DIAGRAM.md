# Earnings Flow - Visual Diagram

## Complete Earnings Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EARNINGS FLOW LIFECYCLE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: CLIENT BOOKS APPOINTMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚  
â”‚  Books Slot â”‚  â†’ Selects time slot
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â†’ Enters details
       â”‚         â†’ Proceeds to payment
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Razorpay   â”‚  â†’ Creates order with notes:
â”‚   Order     â”‚     â€¢ partner_id
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â€¢ slot_id
       â”‚            â€¢ payment_type: 'booking_fee'
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Payment   â”‚  â†’ Client completes payment
â”‚   Gateway   â”‚  â†’ Card details, UPI, etc.
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼


Step 2: PAYMENT CAPTURED (Immediate)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Razorpay   â”‚  â†’ Payment status: 'captured'
â”‚  Captures   â”‚  â†’ Amount: â‚¹500 (example)
â”‚  Payment    â”‚  â†’ Payment ID: pay_xxxxx
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Webhook: payment.captured
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚  â†’ Receives webhook
â”‚  Webhook    â”‚  â†’ Verifies signature
â”‚  Handler    â”‚  â†’ Extracts payment details
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create     â”‚  â†’ INSERT INTO earnings:
â”‚  Earnings   â”‚     â€¢ recipient_id: [partner_id]
â”‚  Record     â”‚     â€¢ recipient_type: 'partner'
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â€¢ razorpay_payment_id: pay_xxxxx
       â”‚            â€¢ amount: 500.00
       â”‚            â€¢ currency: INR
       â”‚            â€¢ status: 'pending' â—„â”€â”€â”€ PENDING STATE
       â”‚            â€¢ payout_date: NULL
       â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EARNINGS TAB - PENDING              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’° Pending Earnings                â”‚   â”‚
â”‚  â”‚  â‚¹500                               â”‚   â”‚
â”‚  â”‚  Payment captured, waiting for      â”‚   â”‚
â”‚  â”‚  Razorpay settlement (T+2/T+3 days) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 3: RAZORPAY SETTLEMENT (T+2 or T+3 Days)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â”‚
       â”‚ Wait 2-3 business days
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Razorpay   â”‚  â†’ Settles payment to merchant account
â”‚  Settles    â”‚  â†’ Typically T+2 or T+3 days
â”‚  Payment    â”‚  â†’ Money moves from Razorpay to merchant
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Webhook: payment.settled / payment.transferred
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚  â†’ Receives settlement webhook
â”‚  Webhook    â”‚  â†’ Finds earnings by payment_id
â”‚  Handler    â”‚  â†’ Calculates next Saturday
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update     â”‚  â†’ UPDATE earnings SET:
â”‚  Earnings   â”‚     â€¢ status: 'available' â—„â”€â”€â”€ AVAILABLE STATE
â”‚  Status     â”‚     â€¢ payout_date: [next Saturday]
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â€¢ updated_at: CURRENT_TIMESTAMP
       â”‚
       â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EARNINGS TAB - AVAILABLE            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â° Pending Earnings                â”‚   â”‚
â”‚  â”‚  â‚¹0                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’µ Available Balance               â”‚   â”‚
â”‚  â”‚  â‚¹500                               â”‚   â”‚
â”‚  â”‚  Payment settled, ready for         â”‚   â”‚
â”‚  â”‚  withdrawal (money in merchant      â”‚   â”‚
â”‚  â”‚  account)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 4: PAYOUT PROCESSING (Weekly - Saturdays)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â”‚
       â”‚ Wait until payout_date (Saturday)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin     â”‚  â†’ Initiates payout batch
â”‚  Processes  â”‚  â†’ Transfers to partner bank account
â”‚   Payout    â”‚  â†’ Creates payout record
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Webhook: payout.processed / payout.completed
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚  â†’ Receives payout webhook
â”‚  Webhook    â”‚  â†’ Finds earnings by payout_date
â”‚  Handler    â”‚  â†’ Updates matching records
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update     â”‚  â†’ UPDATE earnings SET:
â”‚  Earnings   â”‚     â€¢ status: 'withdrawn' â—„â”€â”€â”€ WITHDRAWN STATE
â”‚  Status     â”‚     â€¢ payout_id: [payout_id]
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â€¢ updated_at: CURRENT_TIMESTAMP
       â”‚
       â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EARNINGS TAB - WITHDRAWN            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’µ Available Balance               â”‚   â”‚
â”‚  â”‚  â‚¹0                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¤ Withdrawn Amount                â”‚   â”‚
â”‚  â”‚  â‚¹500                               â”‚   â”‚
â”‚  â”‚  Total payment transferred to       â”‚   â”‚
â”‚  â”‚  partner/organization bank account  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Earnings Status State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PAYMENT    â”‚
                    â”‚   CAPTURED   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Create earnings record
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â–ºâ”‚   PENDING    â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚
              â”‚            â”‚ T+2/T+3 days settlement
              â”‚            â–¼
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     â”‚  AVAILABLE   â”‚â—„â”€â”€â”€â”€â”
              â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚            â”‚             â”‚
              â”‚            â”‚ Payout      â”‚ Admin can
              â”‚            â”‚ processed   â”‚ hold/release
              â”‚            â–¼             â”‚
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
              â”‚     â”‚  WITHDRAWN   â”‚     â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚                          â”‚
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
              â””â”€â”€â”€â”€â”€â”¤     HELD     â”‚â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–²
                           â”‚ Admin action
                           â”‚ (fraud, dispute)
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CANCELLED   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE TABLES                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  razorpay_orders    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  razorpay_order_id  â”‚â—„â”€â”€â”
â”‚  customer_id        â”‚   â”‚
â”‚  customer_type      â”‚   â”‚
â”‚  notes (JSONB)      â”‚   â”‚ References
â”‚    â€¢ partner_id     â”‚   â”‚
â”‚    â€¢ slot_id        â”‚   â”‚
â”‚    â€¢ payment_type   â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ razorpay_payments   â”‚   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚ razorpay_payment_id â”‚â—„â”€â”€â”¼â”€â”€â”
â”‚ razorpay_order_id   â”‚â”€â”€â”€â”˜  â”‚
â”‚ amount              â”‚      â”‚
â”‚ currency            â”‚      â”‚
â”‚ status              â”‚      â”‚ References
â”‚ customer_id         â”‚      â”‚
â”‚ customer_type       â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚      earnings       â”‚      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚ id (PK)             â”‚      â”‚
â”‚ recipient_id        â”‚â—„â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Partner ID
â”‚ recipient_type      â”‚      â”‚
â”‚ razorpay_payment_id â”‚â”€â”€â”€â”€â”€â”€â”˜
â”‚ amount              â”‚
â”‚ currency            â”‚
â”‚ status              â”‚ â—„â”€â”€â”€ PENDING â†’ AVAILABLE â†’ WITHDRAWN
â”‚ payout_date         â”‚ â—„â”€â”€â”€ Next Saturday after settlement
â”‚ payout_id           â”‚â—„â”€â”€â”
â”‚ appointment_id      â”‚   â”‚
â”‚ session_id          â”‚   â”‚
â”‚ created_at          â”‚   â”‚
â”‚ updated_at          â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      payouts        â”‚   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚ id (PK)             â”‚â”€â”€â”€â”˜
â”‚ recipient_id        â”‚
â”‚ recipient_type      â”‚
â”‚ amount              â”‚
â”‚ status              â”‚
â”‚ payout_date         â”‚
â”‚ transaction_id      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Earnings Tab UI Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EARNINGS TAB                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â„¹ï¸  Payment Information Notice                            â”‚ â”‚
â”‚  â”‚  Payments received via TheraPTrack's integrated payment    â”‚ â”‚
â”‚  â”‚  gateways will be processed as follows:                    â”‚ â”‚
â”‚  â”‚  Saturday: All payments received after last Saturday's     â”‚ â”‚
â”‚  â”‚  payout.                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â° Pending   â”‚ â”‚ ğŸ’µ Available â”‚ â”‚ ğŸ’° Total     â”‚ â”‚ ğŸ“¤ Withâ”‚ â”‚
â”‚  â”‚   Earnings   â”‚ â”‚   Balance    â”‚ â”‚   Earnings   â”‚ â”‚  drawn â”‚ â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚  Amountâ”‚ â”‚
â”‚  â”‚   â‚¹500       â”‚ â”‚   â‚¹1,000     â”‚ â”‚   â‚¹3,500     â”‚ â”‚ â‚¹2,000 â”‚ â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚        â”‚ â”‚
â”‚  â”‚ Payment      â”‚ â”‚ Payment      â”‚ â”‚              â”‚ â”‚ Total  â”‚ â”‚
â”‚  â”‚ captured,    â”‚ â”‚ settled,     â”‚ â”‚              â”‚ â”‚ paymentâ”‚ â”‚
â”‚  â”‚ waiting for  â”‚ â”‚ ready for    â”‚ â”‚              â”‚ â”‚ transf â”‚ â”‚
â”‚  â”‚ Razorpay     â”‚ â”‚ withdrawal   â”‚ â”‚              â”‚ â”‚ erred  â”‚ â”‚
â”‚  â”‚ settlement   â”‚ â”‚              â”‚ â”‚              â”‚ â”‚        â”‚ â”‚
â”‚  â”‚ (T+2/T+3)    â”‚ â”‚              â”‚ â”‚              â”‚ â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  âœ… Completed Sessions: 25                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“Š Revenue by Month                                        â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚      â”ƒ                                                      â”‚ â”‚
â”‚  â”‚  â‚¹3K â”ƒ     â–ˆâ–ˆ                                               â”‚ â”‚
â”‚  â”‚      â”ƒ     â–ˆâ–ˆ                                               â”‚ â”‚
â”‚  â”‚  â‚¹2K â”ƒ     â–ˆâ–ˆ  â–ˆâ–ˆ                                           â”‚ â”‚
â”‚  â”‚      â”ƒ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ                                       â”‚ â”‚
â”‚  â”‚  â‚¹1K â”ƒ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ                                   â”‚ â”‚
â”‚  â”‚      â”ƒ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ                               â”‚ â”‚
â”‚  â”‚   â‚¹0 â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚       Sep Oct Nov Dec Jan Feb                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Timeline Example

```
Day 0 (Monday)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•
10:00 AM - Client books appointment
10:01 AM - Payment captured (â‚¹500)
10:01 AM - Earnings created (status: pending)
10:01 AM - UI shows: Pending â‚¹500, Available â‚¹0, Total â‚¹500

Day 2 (Wednesday)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
03:00 PM - Razorpay settles payment
03:01 PM - Webhook received: payment.settled
03:01 PM - Earnings updated (status: available, payout_date: Saturday)
03:01 PM - UI shows: Pending â‚¹0, Available â‚¹500, Total â‚¹500

Day 5 (Saturday)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
12:00 PM - Admin processes weekly payout
12:30 PM - Money transferred to partner bank
01:00 PM - Webhook received: payout.processed
01:01 PM - Earnings updated (status: withdrawn)
01:01 PM - UI shows: Pending â‚¹0, Available â‚¹0, Withdrawn â‚¹500, Total â‚¹500
```

---

## Multiple Payments Example

```
Timeline with 3 Payments
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Day 0: Payment 1 captured (â‚¹500)
â”œâ”€ Pending: â‚¹500
â”œâ”€ Available: â‚¹0
â”œâ”€ Withdrawn: â‚¹0
â””â”€ Total: â‚¹500

Day 1: Payment 2 captured (â‚¹1000)
â”œâ”€ Pending: â‚¹1,500
â”œâ”€ Available: â‚¹0
â”œâ”€ Withdrawn: â‚¹0
â””â”€ Total: â‚¹1,500

Day 2: Payment 1 settled
â”œâ”€ Pending: â‚¹1,000
â”œâ”€ Available: â‚¹500
â”œâ”€ Withdrawn: â‚¹0
â””â”€ Total: â‚¹1,500

Day 3: Payment 2 settled, Payment 3 captured (â‚¹750)
â”œâ”€ Pending: â‚¹750
â”œâ”€ Available: â‚¹1,500
â”œâ”€ Withdrawn: â‚¹0
â””â”€ Total: â‚¹2,250

Day 5: Payment 3 settled
â”œâ”€ Pending: â‚¹0
â”œâ”€ Available: â‚¹2,250
â”œâ”€ Withdrawn: â‚¹0
â””â”€ Total: â‚¹2,250

Day 7: Payout processed
â”œâ”€ Pending: â‚¹0
â”œâ”€ Available: â‚¹0
â”œâ”€ Withdrawn: â‚¹2,250
â””â”€ Total: â‚¹2,250
```

---

## API Endpoints Involved

```
POST /api/razorpay/booking-order
â”œâ”€ Creates Razorpay order
â”œâ”€ Stores order in database with notes
â””â”€ Returns order details to frontend

POST /api/razorpay/verify-booking-payment
â”œâ”€ Verifies payment signature
â”œâ”€ Creates payment record
â”œâ”€ Creates earnings record (status: pending)
â””â”€ Returns success

POST /api/razorpay/webhook
â”œâ”€ Receives Razorpay webhooks
â”œâ”€ Handles payment.captured
â”œâ”€ Handles payment.settled
â”œâ”€ Handles payout.processed
â””â”€ Updates earnings status accordingly

GET /api/earnings/summary
â”œâ”€ Calculates pending earnings
â”œâ”€ Calculates available balance
â”œâ”€ Calculates withdrawn amount
â”œâ”€ Calculates total earnings
â”œâ”€ Gets session statistics
â””â”€ Returns revenue by month
```

---

## Key Calculations

### Pending Earnings
```sql
SUM(amount) WHERE status = 'pending'
```

### Available Balance
```sql
SUM(amount) WHERE status = 'available'
```

### Withdrawn Amount
```sql
SUM(amount) WHERE status = 'withdrawn'
```

### Total Earnings
```sql
SUM(amount) WHERE status IN ('pending', 'available', 'withdrawn')
```

### Next Saturday Calculation
```javascript
function getNextSaturday() {
  const today = new Date();
  const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
  const daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
  const nextSaturday = new Date(today);
  nextSaturday.setDate(today.getDate() + daysUntilSaturday);
  return nextSaturday;
}
```

---

**Reference:** See `EARNINGS_TESTING_GUIDE.md` for detailed testing instructions.
